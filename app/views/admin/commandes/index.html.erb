<div class="admin-header">
  <h1>📋 Gestion des Commandes</h1>
  <p>Interface d'administration - SmartOrder</p>
</div>

<!-- Statistiques -->
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-number" style="color: #f39c12;"><%= @commandes.where(statut: 'en_attente').count %></div>
    <div class="stat-label">En attente</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" style="color: #3498db;"><%= @commandes.where(statut: 'en_preparation').count %></div>
    <div class="stat-label">En préparation</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" style="color: #27ae60;"><%= @commandes.where(statut: 'prete').count %></div>
    <div class="stat-label">Prêtes</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" style="color: #95a5a6;"><%= @commandes.where(statut: 'servie').count %></div>
    <div class="stat-label">Servies</div>
  </div>
</div>

<!-- Filtres -->
<div style="margin-bottom: 2rem;">
  <div class="nav-tabs">
    <%= link_to "Toutes", admin_commandes_path, 
        class: "nav-tab #{'active' if params[:statut].blank?}" %>
    <%= link_to "En attente", admin_commandes_path(statut: 'en_attente'), 
        class: "nav-tab #{'active' if params[:statut] == 'en_attente'}" %>
    <%= link_to "En préparation", admin_commandes_path(statut: 'en_preparation'), 
        class: "nav-tab #{'active' if params[:statut] == 'en_preparation'}" %>
    <%= link_to "Prêtes", admin_commandes_path(statut: 'prete'), 
        class: "nav-tab #{'active' if params[:statut] == 'prete'}" %>
    <%= link_to "Servies", admin_commandes_path(statut: 'servie'), 
        class: "nav-tab #{'active' if params[:statut] == 'servie'}" %>
  </div>
</div>

<!-- Bouton de rafraîchissement -->
<div style="margin-bottom: 1rem; text-align: right;">
  <%= button_to "🔄 Actualiser", admin_commandes_path, 
      method: :get, 
      class: "btn btn-secondary",
      form: { style: "display: inline;" } %>
</div>

<!-- Liste des commandes -->
<div class="commandes-list">
  <% if @commandes.any? %>
    <% @commandes.each do |commande| %>
      <div class="commande-card">
        <div class="commande-header">
          <div class="commande-info">
            <h3>Commande #<%= commande.id %> - Table <%= commande.table.numero %></h3>
            <div class="commande-meta">
              📅 <%= l commande.created_at, format: :short %>
              • 💰 <%= format_price_dt(commande.ligne_commandes.sum { |lc| lc.plat.prix_en_centimes * lc.quantite }) %>
            </div>
          </div>
          <div class="status-badge status-<%= commande.statut %>">
            <%= commande.statut.humanize %>
          </div>
        </div>

        <div class="commande-content">
          <% commande.ligne_commandes.each do |lc| %>
            <div class="ligne-commande">
              <div class="ligne-commande-info">
                <strong><%= lc.plat.nom %></strong> × <%= lc.quantite %>
                <% if lc.remarque.present? %>
                  <br><em style="color: #7f8c8d;">💬 <%= lc.remarque %></em>
                <% end %>
              </div>
              <div class="ligne-commande-prix">
                <%= format_price_dt(lc.plat.prix_en_centimes * lc.quantite) %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="commande-actions" style="margin-top: 1rem;">
          <!-- Formulaire de mise à jour - prend toute la largeur sur mobile -->
          <%= form_with model: [:admin, commande], method: :patch, local: true, 
              class: "commande-update-form",
              style: "margin-bottom: 0.5rem;" do |f| %>
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
              <%= f.select :statut, 
                  options_for_select([
                    ['En attente', 'en_attente'],
                    ['En préparation', 'en_preparation'], 
                    ['Prête', 'prete'],
                    ['Servie', 'servie']
                  ], commande.statut), 
                  {}, 
                  { class: "form-control", style: "flex: 1; min-width: 120px;" } %>
              <%= f.submit "Mettre à jour", class: "btn btn-primary", style: "white-space: nowrap;" %>
            </div>
          <% end %>
          
          <!-- Conteneur pour les boutons Détails et Supprimer -->
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <%= link_to "👁️ Détails", admin_commande_path(commande), 
                class: "btn btn-secondary", style: "flex: 1; text-align: center; min-width: 100px;" %>
            
            <button type="button" class="btn btn-danger commande-delete-btn" 
                    data-id="<%= commande.id %>"
                    style="flex: 1; text-align: center; min-width: 100px;">
              🗑️ Supprimer
            </button>
          </div>

          <!-- Formulaire DELETE invisible -->
          <%= form_with url: admin_commande_path(commande), method: :delete, local: true,
                html: { id: "delete-form-#{commande.id}", style: "display: none;" } do |f| %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="commande-card" style="text-align: center; padding: 3rem;">
      <h3 style="color: #7f8c8d;">Aucune commande trouvée</h3>
      <p style="color: #bdc3c7;">Les nouvelles commandes apparaîtront ici</p>
    </div>
  <% end %>
</div>

<style>
/* CSS responsive pour les boutons des commandes */
@media (max-width: 768px) {
  .commande-actions {
    display: flex !important;
    flex-direction: column !important;
    gap: 0.5rem !important;
  }
  
  .commande-actions .commande-update-form div {
    flex-wrap: wrap !important;
  }
  
  .commande-actions .commande-update-form .form-control {
    min-width: 100% !important;
    margin-bottom: 0.5rem;
  }
  
  .commande-actions .btn {
    font-size: 0.9rem !important;
    padding: 0.5rem 1rem !important;
  }
}

@media (max-width: 480px) {
  .commande-actions div:last-of-type {
    flex-direction: column !important;
  }
  
  .commande-actions .btn {
    width: 100% !important;
    flex: none !important;
  }
}
</style>

<script>
// Auto-refresh toutes les 30 secondes
setInterval(() => {
  if (document.visibilityState === 'visible') {
    window.location.reload()
  }
}, 30000)

// Confirmation pour les changements de statut
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.commande-update-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault()
      
      const select = form.querySelector('select')
      const commandeId = form.action.split('/').pop()
      const newStatus = select.options[select.selectedIndex].text
      
      Swal.fire({
        title: 'Confirmer le changement',
        text: `Changer le statut de la commande #${commandeId} vers "${newStatus}" ?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirmer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#dc3545'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit()
        }
      })
    })
  })
})
// Confirmation pour la suppression
document.addEventListener('turbo:load', function() {
  document.querySelectorAll('.commande-delete-btn').forEach(btn => {
    // Supprimer d'abord un éventuel ancien listener pour éviter double binding
    btn.replaceWith(btn.cloneNode(true));
  });

  document.querySelectorAll('.commande-delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const commandeId = btn.dataset.id;
      const form = document.getElementById(`delete-form-${commandeId}`);

      Swal.fire({
        title: 'Supprimer la commande',
        text: `Voulez-vous vraiment supprimer la commande #${commandeId} ?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#e74c3c',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit(); // Rails gère le DELETE correctement
        }
      })
    });
  });
});



</script>
