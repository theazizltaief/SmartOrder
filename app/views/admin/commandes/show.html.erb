<div class="admin-header">
  <h1>ðŸ“‹ DÃ©tails de la Commande #<%= @commande.id %></h1>
  <p>Table <%= @commande.table.numero %> â€¢ <%= l @commande.created_at, format: :long %></p>
</div>

<!-- Actions rapides -->
<div style="margin-bottom: 2rem;">
  <%= link_to "â† Retour aux commandes", admin_commandes_path, 
      class: "btn btn-secondary" %>
  
  <% if @commande.statut != 'servie' %>
    <%= form_with model: [:admin, @commande], method: :patch, 
        style: "display: inline-block; margin-left: 1rem;" do |f| %>
      <%= f.select :statut, 
          options_for_select([
            ['En attente', 'en_attente'],
            ['En prÃ©paration', 'en_preparation'], 
            ['PrÃªte', 'prete'],
            ['Servie', 'servie']
          ], @commande.statut), 
          {}, 
          { class: "form-control", style: "width: auto; display: inline-block;" } %>
      <%= f.submit "Mettre Ã  jour", class: "btn btn-primary", style: "margin-left: 0.5rem;" %>
    <% end %>
  <% end %>
</div>

<!-- Informations de la commande -->
<div class="commande-card">
  <div class="commande-header">
    <div class="commande-info">
      <h3>Commande #<%= @commande.id %> - Table <%= @commande.table.numero %></h3>
      <div class="commande-meta">
        ðŸ“… <%= l @commande.created_at, format: :short %>
        â€¢ ðŸ’° <%= format_price_dt(@commande.ligne_commandes.sum { |lc| lc.plat.prix_en_centimes * lc.quantite }) %>
      </div>
    </div>
    <div class="status-badge status-<%= @commande.statut %>">
      <%= @commande.statut.humanize %>
    </div>
  </div>

  <div class="commande-content">
    <h4 style="margin-bottom: 1rem;">Articles commandÃ©s :</h4>
    <% @commande.ligne_commandes.each do |lc| %>
      <div class="ligne-commande">
        <div class="ligne-commande-info">
          <strong><%= lc.plat.nom %></strong> Ã— <%= lc.quantite %>
          <br>
          <small style="color: #7f8c8d;"><%= lc.plat.description %></small>
          <% if lc.remarque.present? %>
            <br><em style="color: #e74c3c;">ðŸ’¬ <%= lc.remarque %></em>
          <% end %>

          <!-- Affichage des options -->
      <% if lc.sauces.present? %>
            <br><strong>Sauces :</strong> <%= lc.sauces.join(", ") %>
          <% end %>
          <% if lc.legumes.present? %>
            <br><strong>LÃ©gumes :</strong> <%= lc.legumes.join(", ") %>
          <% end %>
          <% if lc.supplements.present? %>
            <br>âž• <strong>SupplÃ©ments :</strong> <%= lc.supplements.join(", ") %>
          <% end %>
        </div>
        <div class="ligne-commande-prix">
          <%= format_price_dt(lc.plat.prix_en_centimes * lc.quantite) %>
          <br>
          <small style="color: #7f8c8d;">
            <%= format_price_dt(lc.plat.prix_en_centimes) %> Ã— <%= lc.quantite %>
          </small>
        </div>
      </div>
    <% end %>
    
    <div style="border-top: 2px solid #e9ecef; margin-top: 1rem; padding-top: 1rem; text-align: right;">
      <h3 style="color: #e74c3c;">
        Total : <%= format_price_dt(@commande.ligne_commandes.sum { |lc| lc.plat.prix_en_centimes * lc.quantite }) %>
      </h3>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form[action*="commandes"]')
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault()
      const select = form.querySelector('select')
      const newStatus = select.options[select.selectedIndex].text
      Swal.fire({
        title: 'Confirmer le changement',
        text: `Changer le statut vers "${newStatus}" ?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Confirmer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#dc3545'
      }).then((result) => {
        if (result.isConfirmed) {
          form.submit()
        }
      })
    })
  }
})
</script>
